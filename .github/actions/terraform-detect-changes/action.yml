name: Detect Changes 
description: Detect changes in Terraform files within the directory tree, returning the directory list.

inputs:
  base-ref:
    required: false
    type: string
    default: origin/main

  merge-ref:
    required: false
    type: string
    default: HEAD

outputs:
  dirs:
    description: Modified directories.
    value: ${{ steps.check-dirs.outputs.dirs }}

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:  
        fetch-depth: 0

    - name: Check modified directories
      id: check-dirs
      shell: bash
      run: |
        echo "Detecting modified directories"
        echo "Changed files detected: "
        echo $(git diff --name-only ${{ inputs.base-ref }}...${{ inputs.merge-ref }})
        folders=$(git diff --name-only ${{ inputs.base-ref }}...${{ inputs.merge-ref }} \
          | grep -E '\.tf$|\.tfvars$' \
          | xargs -n1 dirname \
          | sort -u \
          | jq -R . \
          | jq -sc .)
        echo "Changed dirs detected:  $folders"
        echo "dirs=$folders" >> $GITHUB_OUTPUT